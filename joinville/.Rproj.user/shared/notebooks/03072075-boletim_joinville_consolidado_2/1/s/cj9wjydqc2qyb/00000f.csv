"0","# Gráfico de incidência municipal - Dengue"
"0","jv_inc_mun_dengon <- create_incidence_plot( "
"0","  nowcast_data = jv_mun_nowscat$mun_nowcast, "
"0","  observed_data = jv_mun_nowscat$mun_observados, "
"0","  title_suffix = paste0(""Curva de incidência de dengue - Joinville até SE"", week_atual),"
"0","  include_zoom = FALSE, "
"0","  convert_to_incidence = TRUE, "
"0","  pop = 616317"
"0",")"
"0",""
"0","# Gráfico de incidência municipal - Chikungunya"
"0","if (any(dados_api$arbo == ""chikon"", na.rm = TRUE)) {"
"0","  min_val <- min(dados_api %>% filter(arbo == ""chikon"") %>% pull(p_inc100k))"
"0","  max_val <- max(dados_api %>% filter(arbo == ""chikon"") %>% pull(p_inc100k))"
"0","  "
"0","  jv_inc_mun_chikon <- dados_api %>%"
"0","    filter(arbo == ""chikon"" & SE >= paste0(ano_atual-1, week_atual)) %>%"
"0","    ggplot() +"
"0","    geom_segment(aes(x = factor(SE), xend = factor(SE), "
"0","                     y = 0, yend = p_inc100k, color = factor(nivel)),"
"0","                 linewidth = 0.7) +"
"0","    geom_line(aes(x = factor(SE), y = p_inc100k, group = 1),"
"0","              color = ""steelblue"", linewidth = 1) +"
"0","    geom_hline(yintercept = 72, col = ""red"") +"
"0","    scale_color_manual("
"0","      name = NULL,"
"0","      values = c(""1"" = ""green"", ""2"" = ""yellow"", ""3"" = ""orange"", ""4"" = ""red""),"
"0","      labels = c(""1"" = ""Baixo Risco"", ""2"" = ""Receptivo"","
"0","                 ""3"" = ""Transmissão"", ""4"" = ""Alta atividade""),"
"0","      breaks = c(""1"", ""2"", ""3"", ""4"")"
"0","    ) +"
"0","    scale_x_discrete("
"0","        breaks = levels(factor(dados_api$SE))["
"0","          seq(1, nlevels(factor(dados_api$SE)), by = 8)]"
"0","  ) +"
"0","    scale_y_continuous(limits = c(min_val, max_val+2)) +"
"0","    theme_minimal() +"
"0","    theme(legend.position = ""top"", axis.text.x = element_text(angle = 45, hjust = 1)) +"
"0","    labs(x = ""Semanas Epidemiológicas"","
"0","         y = ""Incidencia (casos por 100.000 hab.)"","
"0","         title = paste0(""Curva de incidência de chikungunya - Joinville até SE"", week_atual))"
"0","} else {"
"0","  jv_inc_mun_chikon <- NULL"
"0","}"
"0",""
"0","# Receptividade climática"
"0","jv_receptividade_climatica <- create_receptivity_plot("
"0","  api_data = dados_api %>% "
"0","    mutate(ano = as.numeric(substr(SE, 1, 4))) %>% "
"0","    filter(arbo == ""dengue"" & ano %in% c(ano_atual-1, ano_atual)),"
"0","  weeks_limit = weeks_2_plot_full[3]"
"0",")"
"0",""
"0","# Comparação histórica - Dengue"
"0","comp_mun_anos_dengon <- dados_api %>% "
"0","  filter(arbo == ""dengue"") %>%  "
"0","  mutate("
"0","    epiweek = as.character(substr(SE, 5, 6)),"
"0","    ano = as.numeric(substr(SE, 1, 4)),"
"0","    pass = case_when("
"0","      ano == ano_atual ~ 1,"
"0","      ano == ano_atual-1 ~ 2,"
"0","      TRUE ~ 3"
"0","    )"
"0","  ) %>% "
"0","  ggplot(aes(x = epiweek)) +"
"0","  geom_line(aes(y = p_inc100k, col = factor(pass), group = ano)) + "
"0","  theme_minimal(base_size = 12) + "
"0","  theme(axis.text.x = element_text(angle = 45, size = 10), legend.position = ""top"") +"
"0","  scale_color_manual("
"0","    values = c(""red"", ""grey48"", 'grey'), "
"0","    labels = c(""Esse ano"", ""2024"", ""10 últimos anos""), "
"0","    name = NULL"
"0","  ) +"
"0","  scale_x_discrete(breaks = c(""01"", ""10"", ""20"", ""30"", ""40"", ""50"")) +"
"0","  labs(x = ""Semanas Epidemiológicas"","
"0","       y = ""Incidencia (casos por 100.000 hab.)"","
"0","       title = ""Curva de incidência de dengue"","
"0","       subtitle = ""Comparação do ano atual com anteriores"")"
"0",""
"0","# Comparação histórica - Chikungunya"
"0","if (any(dados_api$arbo == ""chikon"", na.rm = TRUE)) {"
"0","  comp_mun_anos_chikon <- dados_api %>% "
"0","    filter(arbo == ""chikon"") %>% "
"0","    mutate("
"0","      epiweek = as.character(substr(SE, 5, 6)),"
"0","      ano = as.numeric(substr(SE, 1, 4)),"
"0","      pass = case_when("
"0","        ano == ano_atual ~ 1,"
"0","        ano == ano_atual-1 ~ 2,"
"0","        TRUE ~ 3"
"0","      )"
"0","    ) %>% "
"0","    ggplot(aes(x = epiweek)) +"
"0","    geom_line(aes(y = p_inc100k, col = factor(pass), group = ano)) + "
"0","    theme_minimal(base_size = 12) + "
"0","    theme(axis.text.x = element_text(angle = 45, size = 10), legend.position = ""top"") +"
"0","    scale_color_manual("
"0","      values = c(""red"", ""grey48"", 'grey'), "
"0","      labels = c(""Esse ano"", ""2024"", ""5 últimos anos""), "
"0","      name = NULL"
"0","    ) +"
"0","    scale_x_discrete(breaks = c(""01"", ""10"", ""20"", ""30"", ""40"", ""50"")) +"
"0","    labs(x = ""Semanas Epidemiológicas"","
"0","         y = ""Incidencia (casos por 100.000 hab.)"","
"0","         title = ""Curva de incidência de chikungunya"","
"0","         subtitle = ""Comparação do ano atual com anteriores"")"
"0","} else {"
"0","  comp_mun_anos_chikon <- NULL"
"0","}"
"0",""
"0","# Número Reprodutivo (Rt) - Municipal"
"0","rt_mun_dengon <- create_rt_plot("
"0","  api_data = dados_api %>% "
"0","    filter(arbo == ""dengue"" & SE >= paste0(ano_atual-1, week_atual)), "
"0","  weeks_limit = weeks_2_plot_full[3], "
"0","  title_suffix = paste0(""Curva de Rt dengue - Joinville até "", week_atual),"
"0","  sem_not = ""SE"""
"0",")"
"0",""
"0","if (any(dados_api$arbo == ""chikon"", na.rm = TRUE)) {"
"0","  rt_mun_chikon <- create_rt_plot("
"0","    api_data = dados_api %>% "
"0","      filter(arbo == ""chikon"" & SE >= paste0(ano_atual-1, week_atual)), "
"0","    weeks_limit = weeks_2_plot_full[3], "
"0","    title_suffix = paste0(""Curva de Rt chikungunya - Joinville até "", week_atual),"
"0","    sem_not = ""SE"""
"0","  )"
"0","} else {"
"0","  rt_mun_chikon <- NULL"
"0","}"
"0",""
"0","# Rt por Distrito - Dengue"
"0","rt_distrito_dengon <- create_rt_plot("
"0","  api_data = df_distritos %>% "
"0","    filter(arbo == ""dengue"" & sem_not >= paste0(ano_atual-1, week_atual)), "
"0","  weeks_limit = weeks_2_plot_full[3], "
"0","  facet_by = ""distrito"","
"0","  title_suffix = """","
"0","  lwr = ""lwr"", upr = ""upr"""
"0",")"
"0",""
"0","# Rt por Distrito - Chikungunya"
"0","if (any(dados_api$arbo == ""chikon"", na.rm = TRUE)) {"
"0","  rt_distrito_chikon <- create_rt_plot("
"0","    api_data = df_distritos %>% "
"0","      filter(arbo == ""chikon"" & sem_not >= paste0(ano_atual-1, week_atual)), "
"0","    weeks_limit = weeks_2_plot_full[3], "
"0","    facet_by = ""distrito"","
"0","    title_suffix = """","
"0","    lwr = ""lwr"", upr = ""upr"","
"0","    sem_not = ""sem_not"""
"0","  )"
"0","} else {"
"0","  rt_distrito_chikon <- NULL"
"0","}"
"0",""
"0","# Incidencia por distrito - Dengue"
"0","jv_inc_distritos_dengon <- map(names(jv_distritos_nowcast), ~ {"
"0","  distrito_nome <- .x"
"0","  create_incidence_plot("
"0","    nowcast_data = jv_distritos_nowcast[[distrito_nome]]$nowcast$total,"
"0","    observed_data = jv_distritos_nowcast[[distrito_nome]]$observado,"
"0","    distrito_nome = distrito_nome, "
"0","    convert_to_incidence = TRUE,"
"0","    pop = populacoes_distritos[distrito_nome],"
"0","    include_zoom = FALSE, "
"0","    title_suffix = distrito_nome"
"0","  )"
"0","})"
"0",""
"0","# Incidencia por distrito - Chikungunya"
"0","if (any(df_distritos$arbo == ""chikon"", na.rm = TRUE)) {"
"0","  min_val <- min(df_distritos %>% filter(arbo == ""chikon"") %>% pull(inc), na.rm = TRUE)"
"0","  max_val <- max(df_distritos %>% filter(arbo == ""chikon"") %>% pull(inc), na.rm = TRUE)"
"0","  "
"0","  jv_inc_distritos_chikon <- df_distritos %>% "
"0","    filter(arbo == ""chikon"" & sem_not >= paste0(ano_atual-1, week_atual)) %>% "
"0","    group_split(distrito) %>%"
"0","    map(~{"
"0","      df_plot <- .x"
"0","      ggplot(df_plot) +"
"0","        geom_segment(aes(x = factor(sem_not), xend = factor(sem_not), "
"0","                         y = 0, yend = inc, color = factor(nivel)),"
"0","                     linewidth = 0.7) +"
"0","        geom_line(aes(x = factor(sem_not), y = inc, group = 1),"
"0","                  color = ""steelblue"", linewidth = 1) +"
"0","        geom_hline(yintercept = 72, col = ""red"") +"
"0","        scale_color_manual("
"0","          name = NULL,"
"0","          values = c(""1"" = ""green"", ""2"" = ""yellow"", ""3"" = ""orange"", ""4"" = ""red""),"
"0","          labels = c(""1"" = ""Baixo Risco"", ""2"" = ""Receptivo"","
"0","                     ""3"" = ""Transmissão"", ""4"" = ""Alta atividade""),"
"0","          breaks = c(""1"", ""2"", ""3"", ""4"")"
"0","        ) +"
"0","        scale_x_discrete("
"0","          breaks = levels(factor(df_plot$sem_not))["
"0","            seq(1, nlevels(factor(df_plot$sem_not)), by = 8)]"
"0","        ) +"
"0","        scale_y_continuous(limits = c(min_val, max_val+5)) +"
"0","        theme_minimal() +"
"0","        theme(legend.position = ""top"", axis.text.x = element_text(angle = 45, hjust = 1)) +"
"0","        labs(x = ""Semanas Epidemiológicas"","
"0","             y = ""Incidencia (casos por 100.000 hab.)"","
"0","             title = unique(df_plot$distrito))"
"0","    })"
"0","} else {"
"0","  jv_inc_distritos_chikon <- NULL"
"0","}"
"0",""
"0","# Top 3 bairros - Dengue"
"0","top_3_bairros_dengon <- df_bairros %>% "
"0","  filter(sem_not == weeks_2_plot_full[3] & arbo == ""dengue"") %>% "
"0","  arrange(desc(inc)) %>%"
"0","  slice_head(n = 3) %>%"
"0","  pull(nm_bairro_ref)"
"0",""
"0","min_val_bairro <- min(df_bairros %>%"
"0","                        filter(arbo == ""dengue"" & "
"0","                                 sem_not >= paste0(ano_atual-1, week_atual)) %>% "
"0","                        pull(inc), na.rm = TRUE)"
"0",""
"0","max_val_bairro <- max(df_bairros %>%"
"0","                        filter(arbo == ""dengue"" & "
"0","                                 sem_not >= paste0(ano_atual-1, week_atual)) %>% "
"0","                        pull(inc), na.rm = TRUE)"
"0",""
"0","jv_inc_bairros_dengon <- df_bairros %>% "
"0","  filter(nm_bairro_ref %in% top_3_bairros_dengon & arbo == ""dengue"" & "
"0","           sem_not >= paste0(ano_atual-1, week_atual)) %>%"
"0","  group_split(nm_bairro_ref) %>%"
"0","  map(~{"
"0","    dados_bairro <- .x"
"0","    ggplot(dados_bairro %>% distinct) +"
"0","      geom_segment(aes(x = factor(sem_not), xend = factor(sem_not), "
"0","                       y = 0, yend = inc, color = factor(nivel)),"
"0","                   linewidth = 0.7) +"
"0","      geom_line(aes(x = factor(sem_not), y = inc, group = 1),"
"0","                color = ""steelblue"", linewidth = 1) +"
"0","      scale_color_manual("
"0","        name = NULL,"
"0","        values = c(""1"" = ""green"", ""2"" = ""yellow"", ""3"" = ""orange"", ""4"" = ""red""),"
"0","        labels = c(""1"" = ""Baixo Risco"", ""2"" = ""Receptivo"","
"0","                   ""3"" = ""Transmissão"", ""4"" = ""Alta atividade""),"
"0","        breaks = c(""1"", ""2"", ""3"", ""4"")"
"0","      ) +"
"0","      theme_minimal() +"
"0","      theme(legend.position = ""top"", axis.text.x = element_text(angle = 45, hjust = 1)) +"
"0","      scale_y_continuous(limits = c(min_val_bairro, max_val_bairro+1)) +"
"0","      labs(x = ""Semanas Epidemiológicas"","
"0","           y = ""Incidencia (casos por 100.000 hab.)"","
"0","           title = unique(dados_bairro$nm_bairro_ref))"
"0","  })"
"0","names(jv_inc_bairros_dengon) <- top_3_bairros_dengon"
"0",""
"0","# Mapas - Distritos"
"0","jv_map_distritos_dengon <- create_map_panel("
"0","  generate_maps("
"0","    data = df_distritos, "
"0","    value_col = ""inc"","
"0","    arbo = ""dengue"","
"0","    weeks_2_plot = as.numeric(as.character(weeks_2_plot_full))"
"0","  )"
"0",")"
"0",""
"0","if (any(df_distritos$arbo == ""chikon"", na.rm = TRUE)) {"
"0","  jv_map_distritos_chikon <- create_map_panel("
"0","    generate_maps("
"0","      data = df_distritos, "
"0","      value_col = ""inc"","
"0","      arbo = ""chikon"","
"0","      weeks_2_plot = as.numeric(as.character(weeks_2_plot_full))"
"0","    )"
"0","  )"
"0","} else {"
"0","  jv_map_distritos_chikon <- NULL"
"0","}"
"0",""
"0","# Mapas - Bairros"
"0","jv_map_bairros_dengon <- create_map_panel("
"0","  generate_maps("
"0","    data = df_bairros,"
"0","    value_col = ""inc"", "
"0","    arbo = ""dengue"","
"0","    weeks_2_plot = as.numeric(as.character(weeks_2_plot_full)),"
"0","    shape = df_distritos, "
"0","    area = ""distrito"""
"0","  )"
"0",")"
"0",""
"0","if (any(df_bairros$arbo == ""chikon"", na.rm = TRUE)) {"
"0","  jv_map_bairros_chikon <- create_map_panel("
"0","    generate_maps("
"0","      data = df_bairros, "
"0","      value_col = ""inc"", "
"0","      arbo = ""chikon"","
"0","      weeks_2_plot = as.numeric(as.character(weeks_2_plot_full)),"
"0","      shape = df_distritos, "
"0","      area = ""distrito"""
"0","    )"
"0","  )"
"0","} else {"
"0","  jv_map_bairros_chikon <- NULL"
"0","}"
"0",""
"0","# Perda de notificação"
"0","perda_notificação <- df_bairros %>% "
"0","  select(sem_not, casos, arbo) %>% "
"0","  group_by(sem_not, arbo) %>% "
"0","  summarise(notificações = sum(casos)) %>% "
"0","  left_join("
"0","    df_mun %>% "
"0","      select(sem_not, nu_notific, arbo) %>% "
"0","      mutate(sem_not = as.numeric(sem_not)) %>% "
"0","      group_by(sem_not, arbo) %>% "
"0","      summarise(notificações_bruto = n_distinct(nu_notific))"
"0","  ) %>% "
"0","  mutate("
"0","    notificações_bruto = ifelse(is.na(notificações_bruto), 0, notificações_bruto),"
"0","    perca = abs(notificações_bruto - notificações),"
"0","    pct_perca = case_when("
"0","      is.na(perca/notificações_bruto) ~ 0,"
"0","      TRUE ~ (perca/notificações_bruto)*100"
"0","    )"
"0","  ) %>% "
"0","  mutate(arbo = factor(arbo, levels = c(""dengue"", ""chikon""),"
"0","                       labels = c(""dengue"", ""chikungunya"")))"
