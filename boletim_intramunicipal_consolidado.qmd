---
title: ""
format:
  pdf:
    fig-width: 4
    include-in-header:
      - text: |
          \usepackage{fancyhdr}
          \usepackage{graphicx}
          \usepackage[export]{adjustbox}
          \usepackage{xcolor}
          \usepackage{hyperref}
          \definecolor{infodengue}{RGB}{0, 83, 156}
          \setlength{\headheight}{70pt}
          \addtolength{\topmargin}{-40pt}
          \input{cabecalho_municipio.tex}
          \pagestyle{fancy}
          \fancyhf{}
          \fancyhead[L]{%
            \begin{minipage}{\textwidth}
              \includegraphics[height=40pt]{~/Documents/intramunicipal/logo1.png}%
              \hfill%
              \includegraphics[height=40pt]{~/Documents/intramunicipal/logo2.png}\\[-6pt]
              \color{infodengue}\rule{\textwidth}{2pt}\\[2pt]
              \color{black}\small\textbf{Boletim Semanal - semana \theweek\ de \theyear}\\[1pt]
            \end{minipage}
          }
          \renewcommand{\headrulewidth}{0pt}
          \fancyfoot[L]{%
            \begin{minipage}{\textwidth}
              \color{infodengue}\rule{\textwidth}{1pt}\\[2pt]
              \color{black}\small%
              \href{https://info.dengue.mat.br/}{InfoDengue}%
              \hfill Boletim Municipal - \themunicipio \hfill SE \theweek\ de \theyear
            \end{minipage}
          }
          \renewcommand{\footrulewidth}{0pt}
          \fancypagestyle{plain}{
            \fancyhf{}
            \fancyhead[L]{%
              \begin{minipage}{\textwidth}
                \includegraphics[height=40pt]{~/Documents/intramunicipal/logo1.png}%
                \hfill%
                \includegraphics[height=40pt]{~/Documents/intramunicipal/logo2.png}\\[-6pt]
                \color{infodengue}\rule{\textwidth}{2pt}\\[2pt]
                \color{black}\small\textbf{Boletim Semanal - semana \theweek\ de \theyear}\\[1pt]
              \end{minipage}
            }
            \renewcommand{\headrulewidth}{0pt}
            \fancyfoot[L]{%
              \begin{minipage}{\textwidth}
                \color{infodengue}\rule{\textwidth}{1pt}\\[2pt]
                \color{black}\small%
                \href{https://info.dengue.mat.br/}{InfoDengue}%
                \hfill Boletim Municipal - \themunicipio \hfill SE \theweek\ de \theyear
              \end{minipage}
            }
            \renewcommand{\footrulewidth}{0pt}
          }
    keep-tex: false
editor: visual
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo    = FALSE,
  message = FALSE,
  warning = FALSE,
  error   = FALSE,
  dev     = "png",
  dpi     = 300,
  fig.align = "center",
  tab.align = "center"
)
```

```{r pacotes, include=FALSE}
pacman::p_load(
  tidyverse, sf, magrittr, fuzzyjoin,
  lubridate, ggpubr, cowplot, gtable,
  nowcaster, AlertTools, epical, gt,
  assertthat, patchwork, kableExtra, arrow,
  terra, MMWRweek
)

source("~/Documents/intramunicipal/funcoes_submunicipal.R")

# Wrapper de calcular_alerta que recebe params explicitamente,
# evitando que AlertTools sobrescreva o params do ambiente global.
# calcular_alerta_safe <- function(id, nome, coluna_id, data, gtdist, meangt, sdgt, params_mun) {
#   params <- params_mun
#   calcular_alerta(id = id, nome = nome, coluna_id = coluna_id,
#                   data = data, gtdist = gtdist, meangt = meangt, sdgt = sdgt)
# }
```

```{r config_municipio, include=FALSE}
# ===========================================================================
# CONFIGURAÇÃO POR MUNICÍPIO
# Adicione novos municípios neste bloco para ampliar o template.
# ===========================================================================

# VERIFICAR AQUI UMA FORMA DE IMPLEMENTAR ISSO NA HORA DE RODAR 
# PARA OS MUNICIPIOS NO PIPELINE

geocodigo <- 2611606 #recife
# geocodigo <- 4209102 #joinville

config_municipios <- list(
  # --- Recife ---
  `2611606` = list(
    nome            = "Recife",
    uf              = "PE",
    populacao       = 1653461,
    n_bairros       = 94,
    caminho_dados   = "~/Documents/dados_teste_intramunicipal/recife/se05/",
    descricao_mun   = paste0(
      "O município de Recife (PE) é o mais populoso do estado (1.488.920 habitantes) ",
      "e possui oficialmente 94 bairros em sua extensão urbana. O uso do espaço urbano ",
      "de acordo com o uso do solo pode ser observado na figura 1."
    ),
    descricao_sub   = paste0(
      "O presente boletim apresenta análises realizadas nos níveis municipal e a nível das 6 ",
      "Regiões Político-Administrativas (RPAs): Norte, Noroeste, Centro, Oeste, Sudoeste e Sul. ",
      "Estas RPAs são uma divisão oficial do município do Recife, estabelecida para organizar e ",
      "descentralizar a gestão pública, permitindo um planejamento mais focado nas especificidades ",
      "de cada área."
    ),
    descricao_dados = paste0(
      "Para a realização das análises foram utilizados os dados do SINAN Online agregados em três ",
      "níveis: municipal, rpa_nome de saúde e bairro. A agregação dos casos por bairro utilizou a ",
      "variável \"NM_BAIRRO\", pois esta apresentou a maior completude (superior ou igual a 70%) ",
      "durante o processo de avaliação prévia dos dados (Figura 3). Primeiramente foi realizada ",
      "padronização dos nomes devido a diferentes grafias ou erros de escrita e remoção das ",
      "notificacoes as quais os nomes dos bairros divergiam muito da grafia oficial ou que não ",
      "constavam da lista dos 94 bairros oficiais. Além disso, para correta agregação dos casos ",
      "por bairro também foram utilizados os arquivos shapefile dos bairros e RPAs, dados ",
      "populacionais para bairros e a listagem do nome dos bairros padronizada e correta."
    ),
    descricao_niveis = paste0(
      "A seguir, são apresentados os resultados das análises em três níveis espaciais: ",
      "nível do município, RPA."
    ),
    label_sub       = "RPA",
    label_sub_pl    = "RPAs",
    titulo_secao    = "Situação das Arboviroses nos Regiões Político-Administrativas (RPAs)",
    rdata_path      = "~/Documents/intramunicipal/recife/ref_RF.RData",
    prefixo         = "rf",               # prefixo dos objetos no RData (rf_ref, rf_pop, etc.)
    col_sub         = "rpa_nome",         # coluna de subdivisão em df_bairros / df_sub
    col_id_sub      = "id_rpa_nome",      # coluna de id numérico da subdivisão
    breaks_anual    = sprintf("%02d", seq(1, 52, by = 4)),
    limiar_preseason  = 6.17,             # sobrescreve params$limiar_preseason do RData se necessário
    limiar_epidemico  = 26.91,
    limiar_posseason  = 8.14,
    prefixo_output  = "rec"
  ),

  # --- Joinville ---
  `4209102` = list(
    nome            = "Joinville",
    uf              = "SC",
    populacao       = 616317,
    n_bairros       = 43,
    caminho_dados = "~/Documents/dados_teste_intramunicipal/joinville/se05",
    descricao_mun   = paste0(
      "O município de Joinville (SC) é o mais populoso do estado (616.317 habitantes) ",
      "e possui oficialmente 43 bairros em sua extensão urbana. O uso do espaço urbano ",
      "de acordo com o uso do solo pode ser observado na figura 1."
    ),
    descricao_sub   = paste0(
      "O presente boletim apresenta análises realizadas nos níveis municipal, de distritos e bairros. ",
      "Os distritos foram agregados com base na intersecção dos bairros com os três distritos de ",
      "abrangência das Unidades Básicas de Saúde (UBS): Distrito Centro, Distrito Norte e Distrito Sul ",
      "(Figura 2). Não capturamos a dinâmica da região rural do município devido a inexistência de ",
      "informações precisas referentes a localização das notificacoes nesta região, no entanto, os ",
      "bairros Morro do Meio, Rio Bonito, Pirabeiraba, Vila Cubatão e Vila Nova frequentemente ",
      "incorporam os casos que são associados à região rural."
    ),
    descricao_dados = paste0(
      "Para a realização das análises foram utilizados os dados do SINAN Online agregados em três ",
      "níveis: municipal, distrito de saúde e bairro. A agregação dos casos por bairro utilizou a ",
      "variável \"NM_BAIRRO\", pois esta apresentou a maior completude (superior ou igual a 70%) ",
      "durante o processo de avaliação prévia dos dados (Figura 3). Primeiramente foi realizada ",
      "padronização dos nomes devido a diferentes grafias ou erros de escrita e remoção das ",
      "notificacoes as quais os nomes dos bairros divergiam muito da grafia oficial ou que não ",
      "constavam da lista dos 43 bairros oficiais. Além disso, para correta agregação dos casos ",
      "por bairro também foram utilizados os arquivos shapefile dos bairros e distritos, dados ",
      "populacionais para bairros e a listagem do nome dos bairros padronizada e correta."
    ),
    descricao_niveis = paste0(
      "A seguir, são apresentados os resultados das análises em três níveis espaciais: ",
      "nível do município, distritos."
    ),
    label_sub       = "Distrito de Saúde",
    label_sub_pl    = "Distritos de Saúde",
    titulo_secao    = "Situação das Arboviroses nos Distritos de Saúde",
    rdata_path      = "~/Documents/intramunicipal/joinville/ref2_JV.RData",
    prefixo         = "jv",
    col_sub         = "distrito",
    col_id_sub      = "id_distrito_nome",
    breaks_anual    = sprintf("%02d", seq(1, 52, by = 4)),
    limiar_preseason  = NULL,             # NULL = lê do objeto params no RData
    limiar_epidemico  = NULL,
    limiar_posseason  = NULL,
    prefixo_output  = "joi"
  )
)

# Valida o geocódigo informado
if (!as.character(geocodigo) %in% names(config_municipios)) {
  stop(
    "Geocódigo '", geocodigo, "' não encontrado em config_municipios.\n",
    "Municípios disponíveis: ", paste(names(config_municipios), collapse = ", ")
  )
}

cfg <- config_municipios[[as.character(geocodigo)]]
```

```{r carregar_dados, include=FALSE, cache=FALSE}
# ---------------------------------------------------------------------------
# Dados de referência espacial e populacionais do município
# ---------------------------------------------------------------------------
load(cfg$rdata_path)

# Limiares MEM (usa config ou lê do objeto params carregado no RData)
# Após load(), "params" = data.frame de 1 linha com limiares MEM do município.
# cfg$limiar_* fixo (ex: Recife) tem precedência; NULL (ex: Joinville) usa o RData.
# [[1]] garante escalar mesmo que params seja data.frame de 1 linha.
limiar_preseason <- cfg$limiar_preseason %||% params$limiar_preseason[[1]]
limiar_epidemico <- cfg$limiar_epidemico %||% params$limiar_epidemico[[1]]
limiar_posseason <- cfg$limiar_posseason %||% params$limiar_posseason[[1]]

# ---------------------------------------------------------------------------
# Dados históricos de alerta via API InfoDengue
# ---------------------------------------------------------------------------
dados_api_dengue <- read.csv(
  file.path(cfg$caminho_dados, "dengue_52-5.csv")
) %>%
  mutate(arbo = "dengue") %>%
  arrange(SE)

dados_api_chikon <- read.csv(
  file.path(cfg$caminho_dados, "chikungunya_52-5.csv")
) %>%
  mutate(arbo = "chikon") %>%
  arrange(SE)

dados_api <- rbind(dados_api_dengue, dados_api_chikon)

# ---------------------------------------------------------------------------
# Dados de notificações (SINAN)
# ---------------------------------------------------------------------------
df_mun <- read_parquet(
  file.path(cfg$caminho_dados, "dengue.parquet")
) %>%
  filter(municipio_geocodigo == geocodigo) %>%
  mutate(
    sem_not    = paste0(ano_notif, sprintf("%02d", se_notif)),
    arbo       = case_when(
      cid10_codigo == "A90"   ~ "dengue",
      cid10_codigo == "A92.0" ~ "chikon",
      cid10_codigo == "A928"  ~ "zika"
    ),
    dt_digita  = as.Date(dt_digita,  format = "%Y-%m-%d"),
    dt_sin_pri = as.Date(dt_sin_pri, format = "%Y-%m-%d"),
    dt_notific = as.Date(dt_notific, format = "%Y-%m-%d")
  ) %>%
  arrange(sem_not)

# ---------------------------------------------------------------------------
# Semanas epidemiológicas de referência
# ---------------------------------------------------------------------------
weeks_2_plot     <- tail(sort(unique(factor(df_mun$sem_not))), 3)
week_atual       <- as.numeric(substr(weeks_2_plot[3], 5, 6))
ano_atual        <- as.numeric(substr(weeks_2_plot[3], 1, 4))
ultimas_3_semanas <- paste0("SE", sprintf("%02d", as.numeric(substr(weeks_2_plot, 5, 6))))
ano_week         <- as.numeric(paste0(ano_atual, sprintf("%02d", week_atual)))

# Breaks para eixos X
breaks_1ano  <- criar_breaks_1ano(ano_fim = ano_atual, semana_fim = week_atual)
breaks_anual <- cfg$breaks_anual

# Gera arquivo .tex com as macros do cabeçalho para esta renderização
writeLines(
  con = "cabecalho_municipio.tex",
  text = c(
    paste0("\\newcommand{\\themunicipio}{", cfg$nome, " - ", cfg$uf, "}"),
    paste0("\\newcommand{\\theweek}{",      week_atual, "}"),
    paste0("\\newcommand{\\theyear}{",      ano_atual,  "}")
  )
)
```

```{r processar_dados, include=FALSE, cache=FALSE}
# ---------------------------------------------------------------------------
# Normalização e matching de bairros
# ---------------------------------------------------------------------------
df_mun_filtrado <- df_mun %>%
  mutate(nm_bairro_norm = normalizar_bairro(nm_bairro)) %>%
  filter(!is.na(nm_bairro_norm))

# Referência de bairros varia por município (rf_ref ou jv_ref)
ref_bairros <- get(paste0(cfg$prefixo, "_ref"))

df_mun_ok <- stringdist_inner_join(
  df_mun_filtrado,
  tibble(nm_bairro_ref = ref_bairros$nome_bairr),
  by     = c("nm_bairro_norm" = "nm_bairro_ref"),
  method = "lv",
  max_dist = 2
)

# ---------------------------------------------------------------------------
# Classificação em subdivisões (RPA ou Distrito)
# ---------------------------------------------------------------------------
if (cfg$prefixo == "rf") {
  # Recife: subdivisão = rpa_nome, geometria disponível em rf_rpa_shape
  res_sub <- rf_rpa_shape %>%
    st_drop_geometry() %>%
    select(bairro_nom, rpa, rpa_nome) %>%
    mutate(nome_bairr = normalizar_bairro(bairro_nom)) %>%
    select(nome_bairr, rpa, rpa_nome) %>%
    rename(!!cfg$col_sub := rpa_nome)

  shape_sub  <- rf_rpa_shape
  pop_ref    <- rf_pop
  col_bairro_pop  <- "bairro_nom"
  col_bairro_ref  <- "nome_bairr"
  col_bairro_shp  <- "bairro_nom"
} else {
  # Joinville: subdivisão = distrito, classificada por função espacial
  res_sub <- classificar_bairros_distrito(
    sp_distritos = jv_distritos_shp,
    sp_bairros   = jv_shp
  ) %>%
    mutate(nome_bairr = normalizar_bairro(nome_bairr))

  shape_sub  <- jv_distritos_shp
  pop_ref    <- jv_pop
  col_bairro_pop  <- "nome_bairr"
  col_bairro_ref  <- "nome_bairr"
  col_bairro_shp  <- "nome_bairr"
}

col_sub <- cfg$col_sub

# ---------------------------------------------------------------------------
# Sumarização por bairro e SE
# ---------------------------------------------------------------------------
df_bairros <- df_mun_ok %>%
  count(arbo, nm_bairro_ref, sem_not, name = "notificações") %>%
  mutate(sem_not = as.numeric(sem_not)) %>%
  completar_dados_bairros(
    bairros_unicos           = unique(df_mun_ok$nm_bairro_ref),
    se_var                   = "sem_not",
    nm_bairr_var             = "nm_bairro_ref",
    group_var                = "arbo",
    max_semana_epidemiologica = weeks_2_plot[3]
  ) %>%
  left_join(pop_ref,    by = c("nm_bairro_ref" = col_bairro_pop)) %>%
  left_join(ref_bairros, by = c("nm_bairro_ref" = col_bairro_ref)) %>%
  left_join(res_sub,    by = c("nm_bairro_ref" = "nome_bairr"))

# Adicionar geometria de bairros e subdivisões
if (cfg$prefixo == "rf") {
  df_bairros <- df_bairros %>%
    left_join(
      rf_rpa_shape %>% select(bairro_nom, rpa_nome, geometry) %>%
        rename(geometry_sub = geometry),
      by = c("nm_bairro_ref" = "bairro_nom", col_sub)
    ) %>%
    select(nm_bairro_ref, sem_not, arbo, !!col_sub,
           notificações, pop, geometry, geometry_sub)
} else {
  df_bairros <- df_bairros %>%
    select(nm_bairro_ref, sem_not, arbo, !!col_sub,
           notificações, pop,  geometry_distritos)#,geometry,)
}

# ---------------------------------------------------------------------------
# Agregação por subdivisão (RPA ou Distrito)
# ---------------------------------------------------------------------------
df_sub <- df_bairros %>%
  st_drop_geometry() %>%
  group_by(!!sym(col_sub), sem_not, arbo) %>%
  summarise(
    pop           = sum(pop, na.rm = TRUE),
    notificações  = sum(notificações, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    inc = notificações / pop * 1e5,
    ano = substr(sem_not, 1, 4)
  ) %>%
  filter(ano %in% c(ano_atual - 1, ano_atual))

# ---------------------------------------------------------------------------
# Dados para nowcasting municipal
# ---------------------------------------------------------------------------
nowcastdg_mun <- df_mun %>%
  filter(year(dt_sin_pri) %in% c(ano_atual - 2, ano_atual - 1, ano_atual) &
           arbo == "dengue") %>%
  drop_na(dt_sin_pri, dt_digita) %>%
  select(arbo, dt_digita, dt_sin_pri, dt_notific)

# Nowcasting por subdivisão
nowcastdg_sub <- df_mun_ok %>%
  filter(arbo == "dengue") %>%
  left_join(res_sub %>% select(nome_bairr, !!col_sub),
            by = c("nm_bairro_ref" = "nome_bairr")) %>%
  select(dt_digita, dt_sin_pri, dt_notific, !!col_sub)
```

```{r calcular_alertas, include=FALSE}
# ---------------------------------------------------------------------------
# Preparar df_sub com temperatura e IDs
# ---------------------------------------------------------------------------
df_sub <- df_sub %>%
  rename(casos = notificações) %>%
  left_join(
    dados_api %>% select(SE, tempmin, arbo) %>% rename(temp_min = tempmin),
    by = c("sem_not" = "SE", "arbo")
  ) %>%
  mutate(
    !!cfg$col_id_sub := as.numeric(factor(!!sym(col_sub))),
    ano  = as.numeric(substr(sem_not, 1, 4)),
    inc  = casos / pop * 1e5
  ) %>%
  as.data.frame()

ids_sub   <- unique(df_sub[[cfg$col_id_sub]])
nomes_sub <- unique(df_sub[[col_sub]])

# calcular_alerta_safe() passa params explicitamente, isolando o ambiente global
# (a função original usa params do ambiente global e o AlertTools o sobrescreve)

# Alertas por subdivisão — Dengue
df_sub_dengon <- map2_dfr(
  ids_sub, nomes_sub, calcular_alerta,
  data       = df_sub %>% filter(arbo == "dengue") %>% distinct(),
  coluna_id  = cfg$col_id_sub,
  gtdist     = "normal",
  meangt     = 3,
  sdgt       = 1
)

# Alertas por subdivisão — Chikungunya
if (any(df_sub$arbo == "chikon", na.rm = TRUE)) {
  df_sub_chikon <- map2_dfr(
    ids_sub, nomes_sub, calcular_alerta,
    data       = df_sub %>% filter(arbo == "chikon") %>% distinct(),
    coluna_id  = cfg$col_id_sub,
    gtdist     = "normal",
    meangt     = 2,
    sdgt       = 2
  )
  df_sub <- rbind(df_sub_dengon, df_sub_chikon)
} else {
  df_sub <- df_sub_dengon
}

# ---------------------------------------------------------------------------
# Alertas por bairro
# ---------------------------------------------------------------------------
df_bairros <- df_bairros %>%
  rename(casos = notificações) %>%
  left_join(
    dados_api %>% select(SE, tempmin, arbo) %>% rename(temp_min = tempmin),
    by = c("sem_not" = "SE", "arbo")
  ) %>%
  mutate(
    id_bairro = as.numeric(factor(nm_bairro_ref)),
    ano       = as.numeric(substr(sem_not, 1, 4)),
    inc       = casos / pop * 1e5
  ) %>%
  as.data.frame()

ids_bairro   <- unique(df_bairros$id_bairro)
nomes_bairro <- unique(df_bairros$nm_bairro_ref)

df_bairros_dengon <- map2_dfr(
  ids_bairro, nomes_bairro, calcular_alerta,
  data       = df_bairros %>% filter(arbo == "dengue") %>% distinct(),
  coluna_id  = "id_bairro",
  gtdist     = "normal",
  meangt     = 3,
  sdgt       = 1
)

if (any(df_bairros$arbo == "chikon", na.rm = TRUE)) {
  df_bairros_chikon <- map2_dfr(
    ids_bairro, nomes_bairro, calcular_alerta,
    data       = df_bairros %>% filter(arbo == "chikon") %>% distinct(),
    coluna_id  = "id_bairro",
    gtdist     = "normal",
    meangt     = 3,
    sdgt       = 1
  )
  df_bairros <- rbind(df_bairros_dengon, df_bairros_chikon)
} else {
  df_bairros <- df_bairros_dengon
}
```

```{r nowcasting, include=FALSE}
# ---------------------------------------------------------------------------
# Nowcasting municipal
# ---------------------------------------------------------------------------
mun_nowscasting <- nowcasting_inla(
  dataset    = nowcastdg_mun,
  data.by.week = TRUE,
  date_onset  = dt_sin_pri,
  date_report = dt_digita,
  K = 1, Dmax = 5
)

mun_observados <- nowcastdg_mun %>%
  filter(arbo == "dengue") %>%
  mutate(
    dt_event = dt_sin_pri,
    epiweek  = epical::epi_week(dt_event)[[1]],
    ano      = year(dt_event),
    ano_epi  = paste0(ano, str_pad(epiweek, width = 2, pad = "0"))
  ) %>%
  count(ano_epi, dt_event, name = "total_Y") %>%
  filter(total_Y != 0 & ano_epi >= paste0(ano_atual - 1, "01")) %>%
  group_by(ano_epi) %>%
  summarise(total_Y = sum(total_Y)) %>%
  left_join(
    dados_api %>%
      filter(arbo == "dengue") %>%
      mutate(SE = as.character(SE)) %>%
      select(SE, nivel),
    by = c("ano_epi" = "SE")
  )

mun_nowcast <- mun_nowscasting$total %>%
  mutate(
    ano     = year(dt_event),
    epiweek = epical::epi_week(dt_event)[[1]],
    ano_epi = case_when(
      epiweek == 1 & lag(epiweek, default = 52) == 52 ~
        paste0(year(dt_event) + 1, str_pad(epiweek, width = 2, pad = "0")),
      TRUE ~ paste0(year(dt_event), str_pad(epiweek, width = 2, pad = "0"))
    ),
    type = if_else(
      ano_epi > as.numeric(as.character(weeks_2_plot[3])),
      "Forecasting", "Nowcasting"
    )
  )

rf_mun_nowscat <- list(mun_observados = mun_observados, mun_nowcast = mun_nowcast)

# ---------------------------------------------------------------------------
# Populações por subdivisão
# ---------------------------------------------------------------------------
populacoes_sub <- pop_ref %>%
  left_join(res_sub %>% select(nome_bairr, !!col_sub),
            by = setNames("nome_bairr", col_bairro_pop)) %>%
  group_by(!!sym(col_sub)) %>%
  summarise(pop = sum(pop, na.rm = TRUE)) %>%
  deframe()

# ---------------------------------------------------------------------------
# Nowcasting por subdivisão (loop genérico)
# ---------------------------------------------------------------------------
nowcast_sub <- list()

for (sub in nomes_sub) {
  dados_sub_filtrado <- nowcastdg_sub %>%
    filter(!!sym(col_sub) == sub)

  sub_nowscasting <- nowcasting_inla(
    dataset     = dados_sub_filtrado,
    data.by.week = TRUE,
    date_onset  = dt_sin_pri,
    date_report = dt_digita,
    K = 2, Dmax = 7
  )

  sub_observados <- dados_sub_filtrado %>%
    mutate(
      dt_event = dt_sin_pri,
      epiweek  = epical::epi_week(dt_event)[[1]],
      ano      = year(dt_event),
      ano_epi  = paste0(ano, str_pad(epiweek, width = 2, pad = "0"))
    ) %>%
    count(ano_epi, dt_event, name = "total_Y") %>%
    filter(total_Y != 0 & ano_epi >= paste0(ano_atual - 1, "01")) %>%
    group_by(ano_epi) %>%
    summarise(total_Y = sum(total_Y), .groups = "drop") %>%
    left_join(
      df_sub_dengon %>%
        filter(!!sym(col_sub) == sub) %>%
        mutate(sem_not = as.character(sem_not)) %>%
        select(sem_not, nivel),
      by = c("ano_epi" = "sem_not")
    )

  sub_nowcast <- sub_nowscasting$total %>%
    mutate(
      ano     = year(dt_event),
      epiweek = epical::epi_week(dt_event)[[1]],
      ano_epi = case_when(
        epiweek == 1 & lag(epiweek, default = 52) == 52 ~
          paste0(ano_atual, str_pad(epiweek, width = 2, side = "left", pad = "0")),
        TRUE ~ paste0(ano, str_pad(epiweek, width = 2, side = "left", pad = "0"))
      ),
      type = if_else(
        ano_epi > as.numeric(as.character(weeks_2_plot[3])),
        "Forecast", "Nowcasting"
      )
    )

  nowcast_sub[[sub]] <- list(
    nowcast  = list(total = sub_nowcast),
    observado = sub_observados
  )
}
```

```{r bairros_ultima_semana, include=FALSE}
# Top 10 bairros — Dengue
bairros_ultima_semana_dengue <- df_bairros %>%
  filter(arbo == "dengue", sem_not == weeks_2_plot[3]) %>%
  slice_head(n = 10) %>%
  select(nm_bairro_ref, !!col_sub, casos, inc, Rt, nivel) %>%
  mutate(Rt = if_else(is.na(Rt), 0, Rt))

bairros_ultima_semana_dengue$semanas_com_nivel3_4 <- sapply(
  bairros_ultima_semana_dengue$nm_bairro_ref,
  function(bairro) calcular_semanas_alerta_alto(
    df_bairros %>% filter(arbo == "dengue"),
    weeks_2_plot[3], bairro, janela = 5
  )
)

bairros_ultima_semana_dengue <- bairros_ultima_semana_dengue %>%
  arrange(desc(inc))

# Top 10 bairros — Chikungunya
bairros_ultima_semana_chikon <- df_bairros %>%
  filter(arbo == "chikon", sem_not == weeks_2_plot[3]) %>%
  slice_head(n = 10) %>%
  select(nm_bairro_ref, !!col_sub, casos, inc, Rt, nivel) %>%
  mutate(Rt = if_else(is.na(Rt), 0, Rt))

bairros_ultima_semana_chikon$semanas_com_nivel3_4 <- sapply(
  bairros_ultima_semana_chikon$nm_bairro_ref,
  function(bairro) calcular_semanas_alerta_alto(
    df_bairros %>% filter(arbo == "chikon"),
    weeks_2_plot[3], bairro, janela = 10
  )
)

bairros_ultima_semana_chikon <- bairros_ultima_semana_chikon %>%
  arrange(desc(inc))
```

```{r gerar_graficos, include=FALSE, cache=FALSE}
# ---------------------------------------------------------------------------
# Completude dos dados (Figura 3)
# ---------------------------------------------------------------------------
df_mun_id_bairro_miss <- df_mun %>%
  group_by(sem_not, arbo) %>%
  summarise(
    total_id  = n(),
    n_missing = sum(id_bairro == 0 | is.na(id_bairro), na.rm = TRUE),
    perc_na_id = 100 * (n_missing / total_id)
  )

df_mun_nm_bairro_miss <- df_mun %>%
  group_by(sem_not, arbo) %>%
  summarise(
    total_nm    = n(),
    n_na_nm     = sum(is.na(nm_bairro)),
    perc_na_nome = 100 * (n_na_nm / total_nm)
  )

df_mun_miss <- left_join(df_mun_id_bairro_miss, df_mun_nm_bairro_miss) %>%
  as.data.frame()

# Função auxiliar para o gráfico de completude
plot_completude <- function(arbo_filtro, subtitulo) {
  df_mun_miss %>%
    filter(sem_not >= paste0(ano_atual, "01") & arbo == arbo_filtro) %>%
    select(sem_not, arbo, perc_na_id, perc_na_nome) %>%
    pivot_longer(cols = c(perc_na_id, perc_na_nome), names_to = "var", values_to = "n") %>%
    mutate(
      var  = case_when(var == "perc_na_id" ~ "ID_BAIRRO", var == "perc_na_nome" ~ "NM_BAIRRO"),
      arbo = factor(ifelse(arbo == "chikon", "chikungunya", arbo),
                    levels = c("dengue", "chikungunya")),
      ew   = substr(sem_not, 5, 6),
      ano  = substr(sem_not, 1, 4)
    ) %>%
    complete(
      ew = sprintf("%02d", 1:52),
      ano = as.character(ano_atual),
      arbo = c("dengue", "chikungunya"),
      var  = c("ID_BAIRRO", "NM_BAIRRO"),
      fill = list(n = NA)
    ) %>%
    filter(ano == ano_atual) %>%
    ggplot() +
    geom_hline(yintercept = 70, linetype = "dashed", color = "black") +
    geom_point(aes(x = factor(ew), y = 100 - n, col = var, group = var), alpha = 0.5) +
    geom_text(aes(label = "Quantidade mínima", x = 10, y = 65)) +
    scale_color_manual(values = c("blue3", "red3")) +
    scale_x_discrete(breaks = breaks_anual) +
    theme_minimal(base_size = 11) +
    theme(axis.text.x = element_text(angle = 60, hjust = 1),
          axis.text    = element_text(colour = "black"),
          legend.position = "top") +
    labs(y = "% de completude", x = "Semanas Epidemiológicas",
         col = "", subtitle = subtitulo) +
    ylim(0, 100)
}

fig3A <- plot_completude("dengue",  "dengue")
fig3B <- plot_completude("chikon", "chikungunya")
fig3  <- ggarrange(fig3A, fig3B, ncol = 1, labels = letters[1:2])

# ---------------------------------------------------------------------------
# Perda de notificação (Figura 4)
# ---------------------------------------------------------------------------
perda_notificação <- df_bairros %>%
  group_by(sem_not, arbo) %>%
  summarise(notificações = sum(casos)) %>%
  left_join(
    df_mun %>%
      select(sem_not, nu_notific, arbo) %>%
      mutate(sem_not = as.numeric(sem_not)) %>%
      group_by(sem_not, arbo) %>%
      summarise(notificações_bruto = n_distinct(nu_notific))
  ) %>%
  mutate(
    notificações_bruto = if_else(is.na(notificações_bruto), 0, notificações_bruto),
    perca      = abs(notificações_bruto - notificações),
    pct_perca  = case_when(
      is.na(perca / notificações_bruto) ~ 0,
      TRUE ~ (perca / notificações_bruto) * 100
    )
  ) %>%
  mutate(arbo = factor(arbo, levels = c("dengue", "chikon"),
                       labels = c("dengue", "chikungunya")))

plot_perda <- function(arbo_filtro, subtitulo) {
  perda_notificação %>%
    filter(
      sem_not >= paste0(ano_atual - 1, substr(weeks_2_plot[3], 5, 6)) &
        arbo == arbo_filtro
    ) %>%
    ggplot() +
    geom_line(aes(x = factor(sem_not), y = perca,          group = 1, col = "Perdidos")) +
    geom_line(aes(x = factor(sem_not), y = notificações,   group = 1, col = "Notificados")) +
    scale_color_manual(values = c("black", "red")) +
    scale_x_discrete(breaks = breaks_1ano) +
    theme_minimal(base_size = 11) +
    theme(axis.text.x = element_text(angle = 60, hjust = 1),
          legend.position = "top") +
    labs(x = "Semanas Epidemiológicas", y = "Casos", colour = "", subtitle = subtitulo)
}

fig4A <- plot_perda("dengue",      "dengue")
fig4B <- plot_perda("chikungunya", "chikungunya")
fig4  <- ggarrange(fig4A, fig4B, ncol = 1, labels = letters[1:2])

# ---------------------------------------------------------------------------
# Incidência municipal — Dengue (Figura 5A)
# ---------------------------------------------------------------------------
rf_inc_mun_dengon <- create_incidence_plot(
  nowcast_data      = rf_mun_nowscat$mun_nowcast,
  observed_data     = rf_mun_nowscat$mun_observados %>% filter(ano_epi <= ano_week),
  title_suffix      = paste0("Curva de incidência de dengue - ", cfg$nome, " até SE", week_atual),
  include_zoom      = FALSE,
  convert_to_incidence = TRUE,
  pop               = cfg$populacao
)

# Incidência municipal — Chikungunya (Figura 5B)
if (any(dados_api$arbo == "chikon", na.rm = TRUE)) {
  rf_inc_mun_chikon <- dados_api %>%
    filter(arbo == "chikon" & SE >= ano_week - 100) %>%
    mutate(nivel = factor(nivel)) %>%
    ggplot() +
    geom_ribbon(aes(x = factor(SE), ymin = 0, ymax = p_inc100k,
                    fill = nivel, group = 1), alpha = 0.3) +
    geom_line(aes(x = factor(SE), y = p_inc100k, group = 1),
              color = "steelblue", linewidth = 1) +
    #geom_hline(yintercept = limiar_epidemico, col = "red") +
    #geom_text(aes(x = 10, y = limiar_epidemico + 1, label = "Limiar Epidêmico")) +
    scale_fill_manual(
      name   = NULL,
      values = c("1" = "green", "2" = "yellow", "3" = "orange", "4" = "red"),
      labels = c("1" = "Baixo Risco", "2" = "Receptivo",
                 "3" = "Transmissão", "4" = "Alta atividade"),
      breaks = c("1", "2", "3", "4")
    ) +
    scale_x_discrete(breaks = breaks_1ano) +
    theme_minimal() +
    theme(legend.position = "top", axis.text.x = element_text(angle = 45, hjust = 1)) +
    labs(x = "Semanas Epidemiológicas",
         y = "Incidência (casos por 100.000 hab.)",
         title = paste0("Curva de incidência de chikungunya - ", cfg$nome, " até SE", week_atual))
} else {
  rf_inc_mun_chikon <- NULL
}

# ---------------------------------------------------------------------------
# Receptividade climática (Figura 6)
# ---------------------------------------------------------------------------
rf_receptividade_climatica <- create_receptivity_plot(
  api_data    = dados_api %>%
    mutate(ano = as.numeric(substr(SE, 1, 4))) %>%
    filter(arbo == "dengue" & ano %in% c(ano_atual - 1, ano_atual)),
  weeks_limit = weeks_2_plot[3]
)

# ---------------------------------------------------------------------------
# Comparação histórica (Figura 7)
# ---------------------------------------------------------------------------
plot_sazonalidade <- function(arbo_filtro, titulo, n_anos) {
  dados_api %>%
    filter(arbo == arbo_filtro) %>%
    mutate(
      epiweek = as.character(substr(SE, 5, 6)),
      ano     = as.numeric(substr(SE, 1, 4)),
      pass    = case_when(
        ano == ano_atual     ~ 1,
        ano == ano_atual - 1 ~ 2,
        TRUE                 ~ 3
      )
    ) %>%
    ggplot(aes(x = epiweek)) +
    geom_line(aes(y = p_inc100k, col = factor(pass), group = ano)) +
    scale_color_manual(
      values = c("red", "grey48", "grey"),
      labels = c("Esse ano", as.character(ano_atual - 1),
                 paste0(n_anos, " últimos anos")),
      name = NULL
    ) +
    scale_x_discrete(breaks = breaks_anual) +
    theme_minimal(base_size = 12) +
    theme(axis.text.x = element_text(angle = 45, size = 10), legend.position = "top") +
    labs(x = "Semanas Epidemiológicas",
         y = "Incidência (casos por 100.000 hab.)",
         title = paste0("Curva de incidência de ", titulo),
         subtitle = "Comparação do ano atual com anteriores")
}

comp_mun_anos_dengon <- plot_sazonalidade("dengue", "dengue",      10)

if (any(dados_api$arbo == "chikon", na.rm = TRUE)) {
  comp_mun_anos_chikon <- plot_sazonalidade("chikon", "chikungunya", 5)
} else {
  comp_mun_anos_chikon <- NULL
}

# ---------------------------------------------------------------------------
# Número reprodutivo (Rt) municipal (Figura 8)
# ---------------------------------------------------------------------------
dados_rt_mun_dengue <- dados_api %>%
  filter(arbo == "dengue") %>%
  rename(sem_not = SE) %>%
  select(sem_not, casos) %>%
  AlertTools::Rt(gtdist = "normal", meangt = 3, sdgt = 1) %>%
  filter(sem_not >= ano_week - 100)

rt_mun_dengon <- create_rt_plot(
  api_data     = dados_rt_mun_dengue %>% rename(SE = sem_not),
  weeks_limit  = weeks_2_plot[3],
  title_suffix = paste0("Curva de Rt dengue - ", cfg$nome, " até ", week_atual),
  sem_not = "SE", lwr = "lwr", upr = "upr"
)

if (any(dados_api$arbo == "chikon", na.rm = TRUE)) {
  dados_rt_mun_chikon <- dados_api %>%
    filter(arbo == "chikon") %>%
    rename(sem_not = SE) %>%
    select(sem_not, casos) %>%
    AlertTools::Rt(gtdist = "normal", meangt = 3, sdgt = 2) %>%
    filter(sem_not >= ano_week - 100)

  rt_mun_chikon <- create_rt_plot(
    api_data     = dados_rt_mun_chikon %>% rename(SE = sem_not),
    weeks_limit  = weeks_2_plot[3],
    title_suffix = paste0("Curva de Rt chikungunya - ", cfg$nome, " até ", week_atual),
    sem_not = "SE", lwr = "lwr", upr = "upr"
  )
} else {
  rt_mun_chikon <- NULL
}

# ---------------------------------------------------------------------------
# Rt por subdivisão (Figura 13)
# ---------------------------------------------------------------------------
rt_sub_dengon <- create_rt_plot(
  api_data     = df_sub %>% filter(arbo == "dengue" & sem_not >= ano_week - 100),
  weeks_limit  = weeks_2_plot[3],
  facet_by     = col_sub,
  title_suffix = "",
  lwr = "lwr", upr = "upr"
)

if (any(df_sub$arbo == "chikon", na.rm = TRUE)) {
  rt_sub_chikon <- create_rt_plot(
    api_data     = df_sub %>% filter(arbo == "chikon" & sem_not >= ano_week - 100),
    weeks_limit  = weeks_2_plot[3],
    facet_by     = col_sub,
    title_suffix = "",
    lwr = "lwr", upr = "upr",
    sem_not = "sem_not"
  )
} else {
  rt_sub_chikon <- NULL
}

# ---------------------------------------------------------------------------
# Incidência por subdivisão — Dengue (Figura 9)
# ---------------------------------------------------------------------------
inc_sub_dengon <- map(names(nowcast_sub), ~ {
  sub_nome <- .x
  create_incidence_plot(
    nowcast_data      = nowcast_sub[[sub_nome]]$nowcast$total,
    observed_data     = nowcast_sub[[sub_nome]]$observado %>% filter(ano_epi <= ano_week),
    distrito_nome     = sub_nome,
    convert_to_incidence = TRUE,
    pop               = populacoes_sub[sub_nome],
    include_zoom      = FALSE,
    title_suffix      = sub_nome
  )
})

# Incidência por subdivisão — Chikungunya (Figura 11)
if (any(df_sub$arbo == "chikon", na.rm = TRUE)) {
  min_val <- min(df_sub %>% filter(arbo == "chikon") %>% pull(inc), na.rm = TRUE)
  max_val <- max(df_sub %>% filter(arbo == "chikon") %>% pull(inc), na.rm = TRUE)

  inc_sub_chikon <- df_sub %>%
    filter(arbo == "chikon" & sem_not >= ano_week - 100) %>%
    group_split(!!sym(col_sub)) %>%
    map(~ {
      df_plot <- .x
      ggplot(df_plot) +
        geom_ribbon(aes(x = factor(sem_not), ymin = 0, ymax = inc,
                        fill = factor(nivel), group = 1), alpha = 0.3) +
        geom_line(aes(x = factor(sem_not), y = inc, group = 1),
                  color = "steelblue", linewidth = 1) +
        geom_hline(yintercept = limiar_epidemico, col = "red") +
        geom_text(aes(x = 10, y = limiar_epidemico + 1, label = "Limiar Epidêmico")) +
        scale_fill_manual(
          name   = NULL,
          values = c("1" = "green", "2" = "yellow", "3" = "orange", "4" = "red"),
          labels = c("1" = "Baixo Risco", "2" = "Receptivo",
                     "3" = "Transmissão", "4" = "Alta atividade"),
          breaks = c("1", "2", "3", "4")
        ) +
        scale_x_discrete(breaks = breaks_1ano) +
        scale_y_continuous(limits = c(min_val, max_val + 5)) +
        theme_minimal() +
        theme(legend.position = "top", axis.text.x = element_text(angle = 45, hjust = 1)) +
        labs(x = "Semanas Epidemiológicas",
             y = "Incidência (casos por 100.000 hab.)",
             title = unique(df_plot[[col_sub]]))
    })
} else {
  inc_sub_chikon <- NULL
}

# ---------------------------------------------------------------------------
# Mapas por subdivisão (Figuras 10, 12)
# ---------------------------------------------------------------------------
shape_col_sub <- if (cfg$prefixo == "rf") "rpa_nome" else "distrito"

map_sub_dengon <- create_map_panel(
  generate_maps(
    data         = df_sub %>%
      left_join(shape_sub %>% select(!!shape_col_sub, geometry),
                by = setNames(shape_col_sub, col_sub)),
    value_col    = "inc",
    arbo         = "dengue",
    weeks_2_plot = as.numeric(as.character(weeks_2_plot))
  )
)

if (any(df_sub$arbo == "chikon", na.rm = TRUE)) {
  map_sub_chikon <- create_map_panel(
    generate_maps(
      data         = df_sub %>%
        left_join(shape_sub %>% select(!!shape_col_sub, geometry),
                  by = setNames(shape_col_sub, col_sub)),
      value_col    = "inc",
      arbo         = "chikon",
      weeks_2_plot = as.numeric(as.character(weeks_2_plot))
    )
  )
} else {
  map_sub_chikon <- NULL
}
```

```{r gerar_tabelas, include=FALSE}
# ---------------------------------------------------------------------------
# Tabela 1 — Casos perdidos
# ---------------------------------------------------------------------------
tab1_dados <- perda_notificação %>%
  filter(sem_not %in% weeks_2_plot) %>%
  arrange(arbo, desc(sem_not)) %>%
  ungroup()

tab1 <- tab1_dados %>%
  select(sem_not, notificações, perca, pct_perca) %>%
  mutate(pct_perca = round(pct_perca, 2)) %>%
  kbl(col.names = c("SE", "Casos notificados", "Casos perdidos", "% perdidos"),
      booktabs = TRUE, align = "c", linesep = "") %>%
  kable_styling(latex_options = c("HOLD_position", "striped"),
                font_size = 10, position = "center") %>%
  pack_rows(index = table(tab1_dados$arbo))

# ---------------------------------------------------------------------------
# Tabela 2 — Resumo municipal
# ---------------------------------------------------------------------------
casos_acum_dengon <- dados_api %>%
  filter(substr(SE, 1, 4) == ano_atual & arbo == "dengue") %>%
  select(SE, casos) %>% arrange(SE) %>%
  mutate(acumulado = cumsum(casos)) %>%
  filter(SE %in% weeks_2_plot) %>%
  mutate(arbo = "dengue") %>% arrange(desc(SE))

casos_acum_chikon <- dados_api %>%
  filter(substr(SE, 1, 4) == ano_atual & arbo == "chikon") %>%
  select(SE, casos) %>% arrange(SE) %>%
  mutate(acumulado = cumsum(casos)) %>%
  filter(SE %in% weeks_2_plot) %>%
  mutate(arbo = "chikungunya") %>% arrange(desc(SE))

acumulados <- bind_rows(casos_acum_dengon, casos_acum_chikon)

tab2_dados <- bind_rows(
  dados_api %>% filter(arbo == "dengue"  & SE %in% weeks_2_plot) %>%
    select(arbo, SE, casos, casos_est, p_inc100k, nivel),
  dados_api %>% filter(arbo == "chikon"  & SE %in% weeks_2_plot) %>%
    select(arbo, SE, casos, casos_est, p_inc100k, nivel)
) %>%
  left_join(acumulados %>% select(SE, arbo, acumulado), by = c("SE", "arbo")) %>%
  select(SE, arbo, acumulado, casos, casos_est, p_inc100k, nivel) %>%
  mutate(
    casos     = round(casos,     0),
    casos_est = round(casos_est, 0),
    p_inc100k = round(p_inc100k, 0),
    acumulado = if_else(is.na(acumulado), 0, acumulado),
    arbo      = factor(arbo, levels = c("dengue", "chikungunya")),
    nivel     = case_when(
      nivel == 1 ~ "verde", nivel == 2 ~ "amarelo",
      nivel == 3 ~ "laranja", nivel == 4 ~ "vermelho"
    )
  ) %>%
  arrange(arbo, desc(SE))

tab2 <- tab2_dados %>%
  select(SE, acumulado, casos, casos_est, p_inc100k, nivel) %>%
  kbl(col.names = c("SE", "Casos acumulados", "Casos notificados",
                    "Casos estimados", "Incidência*", "Nível"),
      booktabs = TRUE, align = "c", linesep = "", escape = FALSE) %>%
  kable_styling(latex_options = c("HOLD_position", "striped"),
                font_size = 10, position = "center") %>%
  pack_rows(index = table(tab2_dados$arbo)) %>%
  column_spec(6, bold = TRUE,
              color = ifelse(tab2_dados$nivel == "verde",   "#369E36",
                      ifelse(tab2_dados$nivel == "amarelo", "#C4BC10",
                      ifelse(tab2_dados$nivel == "laranja", "orange",
                      ifelse(tab2_dados$nivel == "vermelho","red", "black"))))) %>%
  footnote(general = "* Casos por 100 mil habitantes", general_title = "")

# ---------------------------------------------------------------------------
# Tabela limiar
# ---------------------------------------------------------------------------
tab_limiar <- data.frame(
  Limiar = c("Pré-sazonal", "Epidêmico", "Pós-sazonal"),
  Valor  = c(round(limiar_preseason, 1),
             round(limiar_epidemico, 1),
             round(limiar_posseason, 1))
) %>%
  kbl(col.names = c("Limiar", "Incidência (casos/100 mil hab.)"),
      booktabs = TRUE, align = "c", linesep = "") %>%
  kable_styling(latex_options = c("HOLD_position"), font_size = 10, position = "center")

# ---------------------------------------------------------------------------
# Função genérica para tabelas de subdivisão (tab3 e tab4)
# ---------------------------------------------------------------------------
tabela_subdivisao <- function(arbo_filtro) {
  casos_acum_sub <- df_sub %>%
    filter(substr(sem_not, 1, 4) == ano_atual & arbo == arbo_filtro) %>%
    select(sem_not, casos, !!col_sub) %>%
    arrange(sem_not, !!sym(col_sub)) %>%
    group_by(!!sym(col_sub)) %>%
    mutate(acumulado = cumsum(casos)) %>%
    filter(sem_not %in% weeks_2_plot) %>%
    arrange(!!sym(col_sub), desc(sem_not))

  tab_dados <- df_sub %>%
    filter(arbo == arbo_filtro & ano == ano_atual & sem_not %in% weeks_2_plot) %>%
    group_by(sem_not, !!sym(col_sub)) %>%
    summarise(casos_notificados = sum(casos), nivel = sum(nivel), .groups = "drop") %>%
    mutate(
      pop   = populacoes_sub[as.character(!!sym(col_sub))],
      inc   = casos_notificados / pop * 1e5,
      nivel = case_when(
        nivel == 1 ~ "verde", nivel == 2 ~ "amarelo",
        nivel == 3 ~ "laranja", nivel == 4 ~ "vermelho"
      ),
      sem_not = as.numeric(as.character(sem_not))
    ) %>%
    left_join(casos_acum_sub %>% select(sem_not, !!col_sub, acumulado)) %>%
    arrange(!!sym(col_sub), desc(sem_not)) %>%
    select(sem_not, acumulado, casos_notificados, inc, nivel, !!col_sub)

  tab <- tab_dados %>%
    mutate(inc = round(inc, 1)) %>%
    select(sem_not, acumulado, casos_notificados, inc, nivel) %>%
    kbl(col.names = c("SE", "Casos acumulados", "Casos notificados", "Incidência*", "Nível"),
        booktabs = TRUE, align = "c", linesep = "", escape = FALSE) %>%
    kable_styling(latex_options = c("HOLD_position", "striped"),
                  font_size = 10, position = "center") %>%
    pack_rows(index = table(tab_dados[[col_sub]])) %>%
    column_spec(5, bold = TRUE,
                color = ifelse(tab_dados$nivel == "verde",   "#369E36",
                        ifelse(tab_dados$nivel == "amarelo", "#C4BC10",
                        ifelse(tab_dados$nivel == "laranja", "orange",
                        ifelse(tab_dados$nivel == "vermelho","red", "black"))))) %>%
    footnote(general = "* Casos por 100 mil habitantes", general_title = "")

  list(tab = tab, dados = tab_dados)
}

res_tab3 <- tabela_subdivisao("dengue")
tab3     <- res_tab3$tab

res_tab4 <- tabela_subdivisao("chikon")
tab4     <- res_tab4$tab

# ---------------------------------------------------------------------------
# Tabela de indicadores
# ---------------------------------------------------------------------------
tabela_indicadores <- tibble::tribble(
  ~Indicadores,    ~Descricao,
  "Casos",         "Número de casos notificados, por data de primeiro sintoma. Esse dado está sujeito a atualização",
  "Casos esperados","Estimação do número de casos atuais após correção estatística do atraso de notificação",
  "Receptividade", "Condições ambientais favoráveis para reprodução e competência do mosquito para transmissão de dengue baseado no clima e na presença de vírus",
  "Transmissão",   "Indicação de transmissão sustentada de dengue, isso é, sequência de semanas com Rt > 1 atualmente ou recentemente",
  "Incidência",    "Indica o quão alta é a incidência semanal atual em comparação com os valores históricos",
  "Nível",         "Nível de atenção para a situação da dengue calculado pelo Infodengue. Veja o Quadro de comparação do nível do Infodengue com os níveis do Plano de Contingência Nacional da Dengue do Ministério da Saúde."
) %>%
  kbl(booktabs = TRUE, align = c("l", "l"), linesep = "", col.names = NULL) %>%
  kable_styling(latex_options = c("HOLD_position"), font_size = 10, position = "center") %>%
  column_spec(1, width = "4cm", bold = TRUE) %>%
  column_spec(2, width = "10cm")

# ---------------------------------------------------------------------------
# Tabela anexo (Plano de Contingência)
# ---------------------------------------------------------------------------
tabela_anexo <- tibble::tribble(
  ~cor,      ~nivel_atencao,                                                     ~situacao,                                                                                                                    ~nivel_contingencia,                    ~situacao_detalhada,
  "Verde",   "Condições não favoráveis para transmissão / baixo risco",           "Atividade viral baixa / temperatura ou umidade relativa baixa/ Poucos rumores no Twitter",                                   "Nenhuma ação de contingência necessária", "-",
  "Amarelo", "Atenção: Condições favoráveis com presença de circulação viral",    "Atividade viral presente (pelo menos 1 caso) / Temperatura ou umidade relativa favoráveis ao vetor/ Presença de rumores no Twitter", "Pré-contingência",                     "Condição climática favorece atividade do vetor",
  "Laranja", "Transmissão sustentada",                                            "Incidência crescente porém dentro dos níveis históricos",                                                                    "Nível 0",                              "Incidência em ascensão por três semanas seguidas + introdução/reintrodução de novo sorotipo ou IP ultrapassar o limite de 1% ou aumento de rumores no Twitter na última semana.",
  "Laranja", "Transmissão sustentada",                                            "Incidência crescente porém dentro dos níveis históricos",                                                                    "Nível 1",                              "Incidência permanecer em ascensão por quatro semanas consecutivas e/ou ocorra notificação de caso grave suspeito ou suspeita de óbito por dengue.",
  "Vermelho","Incidência alta",                                                   "Incidência alta para os padrões históricos (acima de 90%)",                                                                  "Nível 2",                              "Número de casos notificados para o ano ultrapassar os do limite máximo com transmissão sustentada de acordo com o diagrama de controle e/ou ocorra um aglomerado de óbitos suspeitos por dengue.",
  "Vermelho","Incidência alta",                                                   "Incidência alta para os padrões históricos (acima de 90%)",                                                                  "Nível 3",                              "Número de casos notificados para o ano ultrapassar os do limite máximo com transmissão sustentada de acordo com o diagrama de controle e de mortalidade por dengue nas últimas quatro semanas for maior ou igual a 0,06/100 mil habitantes."
) %>%
  kbl(booktabs = TRUE,
      col.names = c("Cor", "Nível de Atenção", "Situação", "Nível de contingência", "Situação"),
      align = c("c", "l", "l", "l", "l"), linesep = "",
      longtable = TRUE,
      caption = "Plano de Contingência Nacional para Controle da Dengue") %>%
  kable_styling(latex_options = c("HOLD_position", "repeat_header"),
                font_size = 7, position = "center") %>%
  column_spec(1, width = "2cm", bold = TRUE,
              background = c("#369E36", "#C4BC10", "orange", "orange", "red", "red")) %>%
  column_spec(2, width = "3.5cm") %>%
  column_spec(3, width = "3cm") %>%
  column_spec(4, width = "2.5cm") %>%
  column_spec(5, width = "3.5cm")
```

```{r casos_acumulados, include=FALSE}
casos_acumulado_atual <- dados_api %>%
  filter(substr(SE, 1, 4) == ano_atual) %>%
  pull(casos) %>%
  sum()

inc_acumulado <- round(casos_acumulado_atual / cfg$populacao * 1e5, 1)
```

```{r, antigo_cabeçalho}
#| eval: false
#| include: false
# Boletim Semanal Municipal
# 
# Semana r week_atual de r ano_atual
# 
# r cfg$nome - r cfg$uf
# 
# Contextualização do município e processamento


```

# Situação das arboviroses em `r cfg$nome` - `r cfg$uf`

## Contextualização do município e processamento

`r cfg$descricao_mun`

```{r fig1, fig.cap="Descrição do espaço urbano do município de acordo com o uso do solo.", fig.height=7, fig.width=6, out.width="50%"}
#| eval: false
#| include: false
fig1
```

`r cfg$descricao_sub`

```{r fig2, fig.cap=paste0("Demarcação do ambiente urbano de ", cfg$nome, ", com bairros e ", cfg$label_sub_pl, "."), fig.width=6, out.width="100%"}
#| eval: false
#| include: false
fig2
```

## Análise da qualidade dos dados notificados

`r cfg$descricao_dados`

```{r fig3, fig.cap=paste0("Completude dos dados notificados de Dengue (A) e Chikungunya (B) até a SE", week_atual, " de acordo com as variáveis de identificação de bairro, nominal (NM_BAIRRO) e numérica (ID_BAIRRO)."), fig.width=6, fig.height=7, out.width="80%"}
fig3
```

A tabela 1 apresenta as informações sobre o número de casos notificados perdidos e o seu percentual em relação ao número de casos totais nas últimas 3 semanas epidemiológicas para dengue e chikungunya. Os casos perdidos correspondem às notificações que não puderam ser alocadas em um determinado bairro devido à falta de preenchimento da variável NM_BAIRRO ou do seu preenchimento com informações muito divergentes à lista de referência (composta por `r cfg$n_bairros` bairros oficiais) e/ou não possuía o preenchimento da variável "ID_BAIRRO". A figura 4 mostra a informação perdida na série temporal do ano passado e ano atual.

**Tabela 1:** Número total de casos notificados, casos perdidos e percentual de casos perdidos (não localizáveis geograficamente) nas últimas três semanas epidemiológicas.

```{r}
tab1
```

```{r fig4, fig.cap=paste0("Número de dados notificados e perdidos de dengue (A) e chikungunya (B) até a SE", week_atual, "."), fig.width=6, fig.height=7, out.width="65%"}
fig4
```

## Análise da situação das arboviroses

Esse boletim analisa as condições de transmissão das arboviroses utilizando dados de clima (Copernicus ERA5) e de notificação de casos (SINAN) fornecidos semanalmente pela CGARB/SVS/MS. A partir desses dados são analisadas as condições de receptividade climática, transmissão e incidência (ver descrição no final do relatório), tendo como objetivo contribuir para a tomada de decisão na sala de situação. `r cfg$descricao_niveis`

## Situação recente das Arboviroses a nível do município

Esse ano foram notificados até o momento, `r format(casos_acumulado_atual, big.mark = ".", decimal.mark = ",")` casos das arboviroses monitoradas, o que corresponde a uma incidência acumulada de `r format(inc_acumulado, big.mark = ".", decimal.mark = ",")` casos por 100.000 habitantes.

## Casos notificados, incidência e variação de casos

A tabela abaixo sumariza, em relação às últimas 3 semanas epidemiológicas (`r ultimas_3_semanas`), o número de casos observados, casos estimados, a incidência por 100 mil habitantes, o total de casos acumulados e o nível de alerta calculados.

**Tabela 2:** Número de casos observados, casos estimados, incidência, receptividade climática e nível de alerta para as últimas três semanas à nível de município.

```{r}
tab2
```

A tabela abaixo categoriza a incidência do município quanto ao limiar epidêmico estabelecido utilizando dados históricos. Valores superiores à 27 casos por 100 mil habitantes indicam o estabelecimento de uma epidemia.

\vspace{3cm}

**Tabela 3:** Limiar epidêmico calculado para o município a partir dos dados históricos.

```{r}
tab_limiar
```

A figura 5 mostra o perfil de incidência de dengue e chikungunya na cidade e as cores indicam o nível de atenção da semana epidemiológica. A descrição dos quatro níveis de atenção do Infodengue e a sua relação com o nível de atenção do Plano de Contingência Nacional estão descritos na tabela em anexo.

```{r fig5, fig.cap=paste0("Curva de incidência de Dengue (A) e Chikungunya (B) - ", cfg$nome, "/", cfg$uf, " até SE", week_atual, ". A linha azul representa o número de casos observados e a linha vermelha horizontal o limiar epidêmico (incidência superior a 27 casos por 100 mil habitantes)."), fig.width=7, fig.height=6, out.width="85%"}
ggarrange(
  rf_inc_mun_dengon,
  rf_inc_mun_chikon,
  ncol = 1,
  labels = letters[1:2]
)
```

## Perfil sazonal da receptividade climática

O perfil sazonal da receptividade climática no município para a transmissão das arboviroses é calculado a partir dos dados meteorológicos e indicam períodos do ano em que há maior risco de transmissão de arboviroses. A figura 6 apresenta uma escala de receptividade que varia de 0 (período pouco receptivo) a 100 (período muito receptivo) sendo que, períodos muito receptivos, marcam a sazonalidade da doença. Observa-se que o período receptivo típico no município ocorre entre as semanas 45 e 15, que corresponde ao período com temperaturas mínimas acima de 18 graus.

```{r fig6, fig.cap=paste0("Receptividade climática e temperatura mínima do município até SE", week_atual, ". A linha amarela corresponde à variação da temperatura mínima durante o período. A área azul corresponde a período com receptividade climática favorável à transmissão de arboviroses, enquanto a área cinza a receptividade abaixo do limiar favorável."), fig.width=7, fig.height=4}
rf_receptividade_climatica
```

## Comparação da sazonalidade atual com anos anteriores

O perfil sazonal das séries temporais de incidência de casos de dengue e chikungunya nos últimos 10 e 5 anos, respectivamente, estão representadas na figura 7 e podem ser comparadas com a incidência desse ano (marcado em vermelho).

```{r fig7, fig.cap="Comparação da incidência do ano atual com do ano passado para Dengue (A) e Chikungunya (B).", fig.height=8, fig.width=7, out.width="70%"}
ggarrange(
  comp_mun_anos_dengon,
  comp_mun_anos_chikon,
  ncol = 1,
  labels = letters[1:2]
)
```

\vspace{3cm}

## Número reprodutivo

O perfil de transmissibilidade da dengue (figura 8) é medido pelo número reprodutivo, Rt. Valores dessa métrica maiores que 1 ou mais de 3 semanas seguidas indicam transmissão sustentada de dengue (figura 8A) ou chikungunya (figura 8B).

```{r fig8, fig.cap=paste0("Número reprodutivo semanal de Dengue (a) e Chikungunya (b) para o município estimado até SE", week_atual, "."), fig.width=5, fig.height=7, out.width="80%"}
ggarrange(
  rt_mun_dengon$combined_plot,
  rt_mun_chikon$combined_plot,
  ncol = 1,
  labels = letters[1:2]
)
```

# `r cfg$titulo_secao`

## Casos notificados, incidência e variação de casos

### Dengue

A tabela abaixo sumariza em relação às últimas 3 semanas epidemiológicas (`r ultimas_3_semanas`) e para cada `r cfg$label_sub`, o número de casos observados, casos estimados, a incidência por 100 mil habitantes, o total de casos acumulados e o nível de alerta calculados.

**Tabela 4:** Número de casos observados, casos estimados, incidência, receptividade climática e nível de alerta para as últimas três semanas, por `r cfg$label_sub`.

```{r}
tab3
```

\vspace{3cm}

A figura 9 mostra o perfil de incidência de dengue nos `r cfg$label_sub_pl` e as cores indicam o nível de atenção da semana epidemiológica.

```{r fig9, fig.cap=paste0("Curva de incidência de Dengue por ", cfg$label_sub_pl, " até SE", week_atual, ". A linha azul representa o número de casos notificados e a linha vermelha horizontal o limiar epidêmico."), fig.width=12, fig.height=12, out.width="100%", out.height="110%"}
plot_grid(plotlist = inc_sub_dengon, ncol = 2)
```

\vspace{1cm}

A figura 10 ilustra a incidência por 100 mil habitantes dos casos notificados de dengue agregados por `r cfg$label_sub` em `r cfg$nome`, entre as semanas epidemiológicas `r ultimas_3_semanas` de `r ano_atual`.

```{r fig10, fig.cap=paste0("Incidência de Dengue (casos por 100.000 habitantes) por ", cfg$label_sub_pl, " nas últimas 3 semanas epidemiológicas."), fig.width=10, fig.height=9, out.width="100%"}
map_sub_dengon
```

### Chikungunya

A tabela abaixo sumariza em relação às últimas 3 semanas epidemiológicas (`r ultimas_3_semanas`) e para cada `r cfg$label_sub`, o número de casos observados, casos estimados, a incidência por 100 mil habitantes, o total de casos acumulados e o nível de alerta calculados.

**Tabela 5:** Número de casos observados, incidência, receptividade climática e nível de alerta para Chikungunya nas últimas três semanas, por `r cfg$label_sub`.

```{r}
tab4
```

A figura 11 mostra o perfil de incidência de chikungunya nos `r cfg$label_sub_pl` e as cores indicam o nível de atenção da semana epidemiológica.

```{r fig11, fig.cap=paste0("Curva de incidência de Chikungunya por ", cfg$label_sub_pl, " até SE", week_atual, "."), fig.width=12, fig.height=12, out.width="100%", out.height="110%"}
plot_grid(plotlist = inc_sub_chikon, ncol = 2)
```

A figura 12 ilustra a incidência por 100 mil habitantes dos casos notificados de chikungunya agregados por `r cfg$label_sub` em `r cfg$nome`, entre as semanas epidemiológicas `r ultimas_3_semanas` de `r ano_atual`.

```{r fig12, fig.cap=paste0("Incidência de Chikungunya (casos por 100.000 habitantes) por ", cfg$label_sub_pl, " nas últimas 3 semanas epidemiológicas."), fig.width=10, fig.height=9, out.width="100%"}
map_sub_chikon
```

## Perfil sazonal da transmissão das Arboviroses

O perfil sazonal das arboviroses está representado nos gráficos abaixo. O perfil sazonal da receptividade climática para os `r cfg$label_sub_pl` apresenta uma escala que varia de 0 (período pouco receptivo) a 100 (período muito receptivo) sendo que, períodos muito receptivos, marcam a sazonalidade da doença.

O perfil de transmissibilidade para estas arboviroses é medido pelo número reprodutivo (Rt), calculado para cada `r cfg$label_sub`. Valores dessa métrica maiores que 1 ou mais de 3 semanas seguidas indicam transmissão sustentada de dengue ou chikungunya.

```{r fig13, fig.cap=paste0("Número reprodutivo de dengue e chikungunya por ", cfg$label_sub, " semanal estimado até SE", week_atual, "."), fig.width=12, fig.height=12, out.width="100%", out.height="110%"}
rt_coluna_dengue <- ggarrange(
  plotlist = map(nomes_sub, ~ {
    rt_sub_dengon$individual_plots[[.x]] + rremove("ylab") + rremove("xlab")
  }),
  nrow = length(nomes_sub),
  labels = letters[seq_along(nomes_sub)],
  font.label = list(size = 12, face = "bold")
) %>%
  annotate_figure(top = text_grob("Dengue", face = "bold", size = 14))

rt_coluna_chik <- ggarrange(
  plotlist = map(nomes_sub, ~ {
    rt_sub_chikon$individual_plots[[.x]] + rremove("ylab") + rremove("xlab")
  }),
  nrow = length(nomes_sub),
  labels = letters[seq_along(nomes_sub)],
  font.label = list(size = 12, face = "bold")
) %>%
  annotate_figure(top = text_grob("Chikungunya", face = "bold", size = 14))

annotate_figure(
  ggarrange(rt_coluna_dengue, rt_coluna_chik, ncol = 2),
  left   = text_grob("Rt", rot = 90, size = 12),
  bottom = text_grob("Semanas epidemiológicas", size = 12)
)
```

# Descrição dos indicadores

```{r}
tabela_indicadores
```

## Notas

-   Os dados de notificação são fornecidos pela Secretaria de Saúde. Esses são dados ainda sujeitos a revisão;

-   Em algumas cidades, é aplicado um modelo de nowcasting (correção da incidência atual em função do tempo até a notificação). Esse modelo só é ajustado em cidades com volume de casos suficiente. Quando não há ajuste, a coluna de casos estimados mostra os mesmos valores da coluna de casos;

-   A análise de receptividade é feita com base em dados de temperatura e umidade do ar coletadas de aeroportos próximos do município. Em alguns municípios, essa informação pode não ser de boa qualidade;

-   Os perfis sazonais de receptividade ambiental e de transmissão são calculados com base na série histórica desde 2010. Foi ajustado um modelo de decisão para identificar as condições climáticas associadas com número reprodutivo maior que 1 na cidade;

-   As análises aqui apresentadas são baseadas nos dados disponíveis até a data do relatório. Atualizações dessas informações podem alterar os níveis atribuídos a cada semana. Em cada novo relatório, toda a série histórica é recalculada, por isso, pode haver divergência entre boletins. Nesse caso, considere sempre a última versão.

\vspace{1cm}

## Créditos

Este é um projeto desenvolvido com apoio da SVS/MS e Fiocruz em resultado da parceria de:

-   Programa de Computação Científica, Fundação Oswaldo Cruz, Rio de Janeiro;

-   Escola de Matemática Aplicada, Fundação Getúlio Vargas;

-   Secretarias Municipais e Estaduais de Saúde participantes do InfoDengue;

## Como citar:

INFODENGUE. Boletim Semanal Municipal de `r cfg$nome` - Semana `r week_atual`/`r ano_atual`. Brasil, `r ano_atual`

## Anexo

Para facilitar a tomada de decisão, o quadro mostra a relação entre os níveis de atenção do Infodengue e os níveis do Plano de Contingência Nacional para Controle da Dengue

```{r}
tabela_anexo
```
